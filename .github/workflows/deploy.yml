name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: ğŸ“¦ Add server to known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
    
    - name: ğŸš€ Deploy to Production Server
      env:
        SSH_USER: ${{ secrets.SSH_USER }}
        SSH_HOST: ${{ secrets.SSH_HOST }}
        PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
      run: |
        ssh $SSH_USER@$SSH_HOST << 'ENDSSH'
          set -e
          
          echo "========================================="
          echo "ğŸš€ Starting Deployment"
          echo "========================================="
          
          cd ${{ secrets.PROJECT_PATH }}
          
          # Maintenance mode
          echo "ğŸ”’ Enabling maintenance mode..."
          php artisan down --retry=60 --secret="deployment-secret-key" || true
          
          # Pull latest code
          echo "ğŸ“¥ Pulling latest code from main branch..."
          git fetch origin main
          git reset --hard origin/main
          
          # Load NVM and use Node v20
          echo "ğŸ”§ Setting up Node.js..."
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm use 20
          
          # Install Node dependencies (INCLUDING devDependencies for build)
          echo "ğŸ“¦ Installing Node dependencies..."
          npm ci
          
          # Build frontend assets
          echo "ğŸ”¨ Building frontend assets..."
          npm run build
          
          # Clean up node_modules to save space (optional)
          echo "ğŸ§¹ Cleaning up dev dependencies..."
          rm -rf node_modules
          npm ci --production
          
          # Build frontend assets
          echo "ğŸ”¨ Building frontend assets..."
          npm run build
          
          # Run database migrations
          echo "ğŸ’¾ Running database migrations..."
          php artisan migrate --force
          
          # Clear all caches
          echo "ğŸ§¹ Clearing all caches..."
          php artisan config:clear
          php artisan cache:clear
          php artisan route:clear
          php artisan view:clear
          
          # Optimize application
          echo "âš¡ Optimizing application..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan event:cache
          
          # Clear OPcache
          echo "ğŸ—‘ï¸ Clearing OPcache..."
          php artisan optimize:clear
          
          # Restart queue workers
          echo "ğŸ”„ Restarting queue workers..."
          php artisan queue:restart
          
          # Restart supervisor workers (if exists)
          if command -v supervisorctl &> /dev/null; then
            supervisorctl restart laravel-worker:* 2>/dev/null || echo "No supervisor workers found"
          fi
          
          # Fix permissions
          echo "ğŸ” Setting correct permissions..."
          chmod -R 775 storage bootstrap/cache
          chown -R www:www .
          
          # Disable maintenance mode
          echo "ğŸ”“ Disabling maintenance mode..."
          php artisan up
          
          echo ""
          echo "========================================="
          echo "âœ… Deployment Completed Successfully!"
          echo "ğŸ• $(date)"
          echo "========================================="
        ENDSSH
    
    - name: âœ… Deployment Status
      if: success()
      run: |
        echo "ğŸ‰ Successfully deployed to production!"
        echo "ğŸŒ Site: https://studioai.allship.vn"
    
    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "ğŸ’¥ Deployment failed! Check the logs above."